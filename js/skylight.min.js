(function () {
    function addStyles() {
        var head = document.head,
            link = document.createElement("link");
        link.type = "text/css";
        link.rel = "stylesheet";
        link.href = "https://www.bodybuilding.com/scripts/skylight.min.css";
        head.appendChild(link);
    }
    function setProductInfo(product, cellNum) {
        var cell = document.querySelectorAll('.skylight__cell')[cellNum],
            classes = "skylight__",
            bbImg = 'bb:image',
            shipping = 'bb:badge',
            bbBrandURL = "bb:brand",
            bbSkuGroups = "bb:skugroups",
            bbProductURL = "bb:target";
        cell.getElementsByTagName('h3')[0].textContent = product.name;
        cell.getElementsByTagName('h4')[0].textContent = product._embedded[bbBrandURL].label;
        cell.querySelector('.skylight__img__cell').getElementsByTagName('img')[0].setAttribute('src', product._links[bbImg][0].href.replace('{?resolution}', '').replace('450', '130'));
        cell.querySelector('.skylight__img__cell').getElementsByTagName('img')[0].setAttribute('alt', product.name);
        cell.querySelector('.skylight__rating__number').textContent = product.rating.value.toFixed(1);
        cell.querySelector('.skylight__rating__number__of').textContent = parseInt(product.rating.count).toLocaleString('en', {useGrouping: true}) + " Reviews";
        cell.setAttribute('href', product._links.canonical.href);
        if (product._embedded.hasOwnProperty(shipping)) {
            cell.querySelector('.skylight__shipping').style.display = "flex";
        }
    }
    function fetchProducts() {
        var opt = this.options,
            i;
        for (i = 0; i < opt.products.length; i += 1) {
            var item, itemLength, //GENERAL VARIABLES
                xhr = new XMLHttpRequest();
            try {
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        var data = JSON.parse(xhr.responseText);
                        setProductInfo(data, i);
                    }
                };
                xhr.open("GET", opt.products[i], false);
                xhr.setRequestHeader("Accept", "application/hal+json");
                xhr.setRequestHeader("BB-App", "marketing, 1.0.0");
                xhr.send(null);
            } catch (e) {
                console.log('Error With Data Request');
            }
        }
    }
    function buildSkylight() {
        var fragment = document.createDocumentFragment(),
            opt = this.options,
            insert = document.querySelector(opt.insertBefore),
            classes = "skylight__",
            i;
        var contain = document.createElement('div');
        var header = document.createElement('h2');
        var cellContain = document.createElement('div');
        for (i = 0; i < opt.numOfCells; i++) {
            var cell = document.createElement('a'),
                cellImgCell = document.createElement('div'),
                cellImg = document.createElement('img'),
                cellTextCell = document.createElement('div'),
                cellProductName = document.createElement('h3'),
                cellBrandName = document.createElement('h4'),
                cellRatingCell = document.createElement('div'),
                cellRatingNumCell = document.createElement('div'),
                cellRatingNumOf = document.createElement('h5'),
                cellShipCell = document.createElement('div'),
                cellShipImg = document.createElement('img');
            cell.classList.add(classes + 'cell');
            cellImgCell.classList.add(classes + 'img__cell');
            cellImg.classList.add(classes + 'img');
            cellTextCell.classList.add(classes + 'text__cell');
            cellProductName.classList.add(classes + 'product__name');
            cellBrandName.classList.add(classes + 'brand__name');
            cellRatingCell.classList.add(classes + 'rating__cell');
            cellRatingNumCell.classList.add(classes + 'rating__number');
            cellRatingNumOf.classList.add(classes + 'rating__number__of');
            cellShipCell.classList.add(classes + 'shipping');
            cellShipImg.classList.add(classes + 'shipping__img');
            cellShipImg.src = 'https://artifacts.bbcomcdn.com/bb-resources/2.6.0/free-shipping/free-shipping-with-orders-wrap.svg';
            cellImgCell.appendChild(cellImg);
            cellShipCell.appendChild(cellShipImg);
            cellRatingCell.innerHTML += cellRatingNumCell.outerHTML + cellRatingNumOf.outerHTML;
            cellTextCell.innerHTML += cellProductName.outerHTML + cellBrandName.outerHTML + cellRatingCell.outerHTML + cellShipCell.outerHTML;
            cell.innerHTML += cellImgCell.outerHTML + cellTextCell.outerHTML;
            cellContain.appendChild(cell);
        }
        contain.classList.add('skylight');
        contain.id = "cross__merch__zone";
        header.classList.add('skylight__header');
        header.textContent = opt.headerText;
        cellContain.classList.add('skylight__cells');
        contain.appendChild(header);
        contain.appendChild(cellContain);
        insert.parentNode.insertBefore(contain, insert.nextSibling);
    }
    this.Skylight = function () {
        this.insertAfter = null;
        this.headerText = null;
        this.products = null;
        var defaults = { //Default Options
            insertBefore: "#vendor-content",
            headerText: "You May Also Like",
            numOfCells: 3,
            products: [
                "https://www.bodybuilding.com/store/opt/whey.html",
                "https://www.bodybuilding.com/store/opt/natwhey.html",
                "https://www.bodybuilding.com/store/opt/cas.html"
            ]
        };
        function extendDefaults(source, properties) {
            var property;
            for (property in properties) {
                if (properties.hasOwnProperty(property)) {
                    source[property] = properties[property];
                }
            }
            return source;
        }
        if (arguments[0] && typeof arguments[0] === "object") {
            this.options = extendDefaults(defaults, arguments[0]);
        }
        addStyles.call(this);
        buildSkylight.call(this);
        fetchProducts.call(this);
        document.querySelector('.skylight').style.opacity = "1";
    };
}());