(function () {
    function addStyles() {
        var link = document.createElement("link");
        link.type = "text/css";
        link.rel = "stylesheet";
        link.href = "https://www.bodybuilding.com/scripts/skylight.min.css";
        document.head.appendChild(link);
    }
    function setProductInfo(product, cellNum, sib) {
        var cell = sib.querySelectorAll('.skylight__cell')[cellNum],
            bbImg = 'bb:image',
            shipping = 'bb:badge',
            bbBrandURL = "bb:brand";
        cell.getElementsByTagName('h3')[0].textContent = product.name;
        cell.getElementsByTagName('h4')[0].textContent = product._embedded[bbBrandURL].label;
        cell.querySelector('.skylight__img__cell').getElementsByTagName('img')[0].setAttribute('src', product._links[bbImg][0].href.replace('{?resolution}', '').replace('450', '130'));
        cell.querySelector('.skylight__img__cell').getElementsByTagName('img')[0].setAttribute('alt', product.name);
        cell.querySelector('.skylight__rating__number').textContent = product.rating.value.toFixed(1);
        cell.querySelector('.skylight__rating__number__of').textContent = parseInt((product.rating.count), 10).toLocaleString('en', {useGrouping: true}) + " Reviews";
        cell.setAttribute('href', product._links.canonical.href);
        product._embedded.hasOwnProperty(shipping) ? cell.querySelector('.skylight__shipping').style.display = "flex" : null;
    }
    function fetchProducts() {
        var opt = this.options, i, xhr, s, sib;
        for (i = 0; i < opt.products.length; i += 1) {
            s = document.querySelector(opt.sibling);
            if (opt.beforeSibling || !opt.afterSibling) {
                sib = s.previousElementSibling;
            } else if (opt.afterSibling) {
                sib = s.nextElementSibling;
            }
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                xhr.readyState === 4 && setProductInfo(JSON.parse(xhr.responseText), i, sib);
            };
            xhr.open("GET", opt.products[i], false);
            xhr.setRequestHeader("Accept", "application/hal+json");
            xhr.setRequestHeader("BB-App", "marketing, 1.0.0");
            xhr.send(null);
        }
    }
    function buildSkylight() {
        var opt = this.options,
            insert = document.querySelector(opt.sibling),
            classes = "skylight__",
            contain = document.createElement('div'),
            header = document.createElement('h2'),
            cellContain = document.createElement('div'),
            i;
        contain.classList.add('skylight');
        contain.id = "cross__merch__zone";
        contain.style.transition = "opacity 0.6s";
        contain.style.opacity = "0";
        contain.setAttribute('data-bb-category', 'merchandising');
        contain.setAttribute('data-bb-label', 'product page cross merch');
        for (i = 0; i < opt.numOfCells; i += 1) {
            var cell = document.createElement('a'),
                cellImgCell = document.createElement('div'),
                cellImg = document.createElement('img'),
                cellTextCell = document.createElement('div'),
                cellProductName = document.createElement('h3'),
                cellBrandName = document.createElement('h4'),
                cellRatingCell = document.createElement('div'),
                cellRatingNumCell = document.createElement('div'),
                cellRatingNumOf = document.createElement('h5'),
                cellShipCell = document.createElement('div'),
                cellShipImg = document.createElement('img');
            cell.classList.add(classes + 'cell');
            cellImgCell.classList.add(classes + 'img__cell');
            cellImg.classList.add(classes + 'img');
            cellTextCell.classList.add(classes + 'text__cell');
            cellProductName.classList.add(classes + 'product__name');
            cellBrandName.classList.add(classes + 'brand__name');
            cellRatingCell.classList.add(classes + 'rating__cell');
            cellRatingNumCell.classList.add(classes + 'rating__number');
            cellRatingNumOf.classList.add(classes + 'rating__number__of');
            cellShipCell.classList.add(classes + 'shipping');
            cellShipImg.classList.add(classes + 'shipping__img');
            cellShipImg.src = 'https://artifacts.bbcomcdn.com/bb-resources/2.6.0/free-shipping/free-shipping-with-orders-wrap.svg';
            cellImgCell.appendChild(cellImg);
            cellShipCell.appendChild(cellShipImg);
            cellRatingCell.innerHTML += cellRatingNumCell.outerHTML + cellRatingNumOf.outerHTML;
            cellTextCell.innerHTML += cellProductName.outerHTML + cellBrandName.outerHTML + cellRatingCell.outerHTML + cellShipCell.outerHTML;
            cell.innerHTML += cellImgCell.outerHTML + cellTextCell.outerHTML;
            cellContain.appendChild(cell);
        }
        header.classList.add('skylight__header');
        opt.headerOverride.length > 0 ? header.textContent = opt.headerOverride : header.textContent = opt.skyZoneHeaders[opt.skyZone];
        cellContain.classList.add('skylight__cells');
        contain.appendChild(header);
        contain.appendChild(cellContain);
        if (opt.beforeSibling || !opt.afterSibling) {
            insert.parentNode.insertBefore(contain, insert);
        } else if (opt.afterSibling) {
            insert.parentNode.insertBefore(contain, insert.nextSibling);
        }
        setTimeout(function () {contain.style.opacity = "1"; }, 100);
    }
    this.Skylight = function () {
        var defaults = { //Default Options
            sibling: "#vendor-content",
            beforeSibling: false,
            afterSibling: true,
            headerOverride: "",
            numOfCells: 3,
            products: [
                "/store/opt/whey.html",
                "/store/opt/natwhey.html",
                "/store/opt/cas.html"
            ],
            skyZone: 1,
            skyZoneHeaders: {
                1: "You May Prefer This",
                2: "Bought With",
                3: "empty",
                4: "empty",
                5: "empty"
            }
        };
        function extendDefaults(source, properties) {
            var property;
            for (property in properties) {
                if (properties.hasOwnProperty(property)) {
                    source[property] = properties[property];
                }
            }
            return source;
        }
        if (arguments[0] && typeof arguments[0] === "object") {
            this.options = extendDefaults(defaults, arguments[0]);
        }
        addStyles();
        buildSkylight.call(this);
        fetchProducts.call(this);
    };
}());